<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wissenschaftlicher Taschenrechner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: transparent;
            margin: 0;
            padding: 0;
        }

        .calculator {
            background: white;
            border-radius: 20px;
            box-shadow: none;
            max-width: 500px;
            width: 100%;
            overflow: hidden;
        }

        .display {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 25px;
            color: white;
            position: relative;
        }

        .input-display {
            font-size: 18px;
            min-height: 30px;
            margin-bottom: 10px;
            opacity: 0.8;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
        }

        .result-display {
            font-size: 36px;
            font-weight: 300;
            min-height: 50px;
            text-align: right;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
        }

        .result-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-row .result-display {
            flex: 1;
        }

        .copy-result {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.5);
            color: white;
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            padding: 0;
        }

        .copy-result svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .copy-result:hover {
            background: rgba(255, 255, 255, 0.35);
        }

        .special-functions {
            background: #f7fafc;
            padding: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .function-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .function-buttons button {
            flex: 1;
            min-width: 70px;
            padding: 8px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            background: #ed8936;
            color: white;
        }

        .function-buttons button:hover {
            background: #dd6b20;
            transform: translateY(-1px);
        }

        .function-buttons button.active {
            background: #667eea;
        }

        .expandable {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .expandable.open {
            max-height: 600px;
        }

        .panel {
            background: white;
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .panel h4 {
            margin-bottom: 6px;
            color: #2d3748;
            font-size: 13px;
        }

        .input-group {
            margin-bottom: 6px;
        }

        .input-group label {
            display: block;
            margin-bottom: 3px;
            color: #4a5568;
            font-size: 11px;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }

        .input-group input[type=number],
        .input-row input[type=number] {
            appearance: textfield;
        }

        .input-group input[type=number]::-webkit-outer-spin-button,
        .input-group input[type=number]::-webkit-inner-spin-button,
        .input-row input[type=number]::-webkit-outer-spin-button,
        .input-row input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-row {
            display: flex;
            gap: 4px;
            margin-bottom: 6px;
            align-items: center;
            flex-wrap: wrap;
        }

        .input-row input {
            width: 40px;
            padding: 4px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 11px;
            text-align: center;
            font-family: 'Courier New', monospace;
        }

        .input-row input:focus {
            outline: none;
            border-color: #667eea;
        }

        .lgs-matrix {
            margin-bottom: 6px;
        }

        .lgs-controls {
            display: flex;
            gap: 4px;
            margin-bottom: 6px;
        }

        .lgs-controls button {
            flex: 1;
            padding: 4px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            background: #48bb78;
            color: white;
            font-weight: 600;
        }

        .lgs-controls button:hover {
            background: #38a169;
        }

        .lgs-controls button.remove {
            background: #f56565;
        }

        .lgs-controls button.remove:hover {
            background: #e53e3e;
        }

        .action-button {
            width: 100%;
            padding: 6px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            background: #667eea;
            color: white;
            margin-top: 6px;
        }

        .action-button:hover {
            background: #5568d3;
        }

        .buttons {
            padding: 12px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        button {
            padding: 10px;
            font-size: 14px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            background: #f5f5f5;
            color: #333;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        button:active {
            transform: translateY(0);
        }

        .operator {
            background: #667eea;
            color: white;
        }

        .operator:hover {
            background: #5568d3;
        }

        .equals {
            background: #48bb78;
            color: white;
        }

        .equals:hover {
            background: #38a169;
        }

        .top-key {
            background: #ed8936;
            color: white;
            font-size: 12px;
        }

        .top-key:hover {
            background: #dd6b20;
        }

        .spacer {
            visibility: hidden;
            pointer-events: none;
        }

        .clear {
            background: #f56565;
            color: white;
        }

        .clear:hover {
            background: #e53e3e;
        }

        .special {
            background: #ed8936;
            color: white;
            font-size: 12px;
        }

        .special:hover {
            background: #dd6b20;
        }

        .wide {
            grid-column: span 2;
        }

        @media (max-width: 600px) {
            .result-display {
                font-size: 28px;
            }

            button {
                padding: 8px;
                font-size: 12px;
            }

            .special {
                font-size: 11px;
            }

            .buttons {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>

<body>
    <div class="calculator">
        <div class="display">
            <div class="input-display" id="inputDisplay">0</div>
            <div class="result-row">
                <div class="result-display" id="resultDisplay">0</div>
                <button class="copy-result" onclick="copyResult()" aria-label="Ergebnis kopieren"
                    title="Ergebnis kopieren">
                    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                        <path
                            d="M16 1H6c-1.1 0-2 .9-2 2v12h2V3h10V1zm3 4H10c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h9c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H10V7h9v14z" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="special-functions">
            <div class="function-buttons">
                <button onclick="togglePanel('lgs')" id="lgsBtn">LGS</button>
                <button onclick="togglePanel('binom')" id="binomBtn">Binom</button>
                <button onclick="togglePanel('equation')" id="equationBtn">Gleichung</button>
            </div>

            <!-- LGS Panel -->
            <div id="lgsPanel" class="expandable">
                <div class="panel">
                    <h4>Lineares Gleichungssystem</h4>
                    <div class="lgs-controls">
                        <button onclick="addLGSVariable()">+ Variable</button>
                        <button class="remove" onclick="removeLGSVariable()">- Variable</button>
                        <button onclick="addLGSEquation()">+ Gleichung</button>
                        <button class="remove" onclick="removeLGSEquation()">- Gleichung</button>
                    </div>
                    <div id="lgsMatrix"></div>
                </div>
            </div>

            <!-- Binomial Panel -->
            <div id="binomPanel" class="expandable">
                <div class="panel">
                    <h4>Binomialwahrscheinlichkeit P(a ≤ X ≤ b)</h4>
                    <div class="input-row">
                        <div style="flex: 1;">
                            <label style="font-size: 11px; color: #718096;">a =</label>
                            <input type="text" id="binomA" inputmode="decimal" autocomplete="off">
                        </div>
                        <div style="flex: 1;">
                            <label style="font-size: 11px; color: #718096;">b =</label>
                            <input type="text" id="binomB" inputmode="decimal" autocomplete="off">
                        </div>
                        <div style="flex: 1;">
                            <label style="font-size: 11px; color: #718096;">n =</label>
                            <input type="text" id="binomN" inputmode="decimal" autocomplete="off">
                        </div>
                        <div style="flex: 1;">
                            <label style="font-size: 11px; color: #718096;">p =</label>
                            <input type="text" id="binomP" inputmode="decimal" autocomplete="off">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gleichung Panel -->
            <div id="equationPanel" class="expandable">
                <div class="panel">
                    <h4>Gleichung lösen</h4>
                    <div class="input-group">
                        <label>Gleichung (z.B. x^2 - 4 = 0 oder e^x - 5 = 0)</label>
                        <input type="text" id="equationInput">
                    </div>
                </div>
            </div>
        </div>

        <div class="buttons">
            <!-- Reihe 1 -->
            <button class="top-key" onclick="appendFunction('sqrt(')">√</button>
            <button class="top-key" onclick="appendOperator('√')">x√y</button>
            <button class="top-key" onclick="appendNumber('π')">π</button>
            <button class="top-key" onclick="appendNumber('e')">e</button>

            <!-- Reihe 2 -->
            <button class="top-key" onclick="appendFunction('sin(')">sin</button>
            <button class="top-key" onclick="appendFunction('cos(')">cos</button>
            <button class="top-key" onclick="appendFunction('tan(')">tan</button>
            <button class="top-key" onclick="appendFunction('ln(')">ln</button>

            <!-- Reihe 3 -->
            <button class="top-key" onclick="appendFunction('exp(')">e^x</button>
            <button class="top-key" onclick="factorial()">n!</button>
            <button class="top-key" onclick="appendOperator('^')">^</button>
            <button class="top-key" onclick="appendFunction('log_(')">log</button>

            <!-- Reihe 4 -->
            <button class="top-key" onclick="appendNumber('(')">(</button>
            <button class="top-key" onclick="appendNumber(')')">)</button>
            <button class="top-key" onclick="appendNumber('x')">x</button>
            <button class="top-key" onclick="appendOperator('=')">=</button>

            <!-- Reihe 5 -->
            <button class="clear" onclick="clearAll()">C</button>
            <button class="clear" onclick="clearEntry()">CE</button>
            <button class="clear" onclick="backspace()">⌫</button>
            <button class="operator" onclick="appendOperator('/')">÷</button>

            <!-- Reihe 6 -->
            <button onclick="appendNumber('7')">7</button>
            <button onclick="appendNumber('8')">8</button>
            <button onclick="appendNumber('9')">9</button>
            <button class="operator" onclick="appendOperator('*')">×</button>

            <!-- Reihe 7 -->
            <button onclick="appendNumber('4')">4</button>
            <button onclick="appendNumber('5')">5</button>
            <button onclick="appendNumber('6')">6</button>
            <button class="operator" onclick="appendOperator('-')">−</button>

            <!-- Reihe 8 -->
            <button onclick="appendNumber('1')">1</button>
            <button onclick="appendNumber('2')">2</button>
            <button onclick="appendNumber('3')">3</button>
            <button class="operator" onclick="appendOperator('+')">+</button>

            <!-- Reihe 9 -->
            <button onclick="toggleSign()">+/-</button>
            <button onclick="appendNumber('0')">0</button>
            <button onclick="appendNumber('.')">.</button>
            <button class="equals" onclick="handleExecute()">EXE</button>
        </div>
    </div>

    <script>
        let currentInput = '0';
        let result = 0;
        let shouldResetInput = false;
        let lgsVariables = 2;
        let lgsEquations = 2;
        let activePanel = null;
        let activeInputField = null;
        let panelInputMode = false;
        const isTouchDevice = (() => {
            if (window.matchMedia && window.matchMedia('(pointer: coarse)').matches) return true;
            return navigator.maxTouchPoints && navigator.maxTouchPoints > 0;
        })();
        const isFinePointer = window.matchMedia
            ? window.matchMedia('(pointer: fine)').matches
            : false;
        const isProbablyMobile = (() => {
            if (navigator.userAgentData && typeof navigator.userAgentData.mobile === 'boolean') {
                return navigator.userAgentData.mobile;
            }
            return /Android|iPhone|iPad|iPod|IEMobile|Opera Mini/i.test(navigator.userAgent);
        })();
        const shouldLockTouchInputs = isTouchDevice && isProbablyMobile && !isFinePointer;

        function updateDisplay() {
            document.getElementById('inputDisplay').textContent = formatDisplay(currentInput);
            document.getElementById('resultDisplay').textContent = result;
        }

        function copyResult() {
            const value = String(result ?? '').trim();
            if (!value) return;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(value);
                return;
            }

            const temp = document.createElement('textarea');
            temp.value = value;
            temp.setAttribute('readonly', '');
            temp.style.position = 'absolute';
            temp.style.left = '-9999px';
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
        }

        function applyTouchInputLock() {
            const inputs = document.querySelectorAll('#binomPanel input, #equationPanel input, #lgsPanel input');
            inputs.forEach((input) => {
                if (shouldLockTouchInputs) {
                    input.readOnly = true;
                    input.inputMode = 'none';
                } else {
                    input.readOnly = false;
                    if (!input.dataset.inputModeLocked) {
                        input.inputMode = 'decimal';
                    }
                }
            });
        }

        function formatDisplay(value) {
            return value
                .replace(/sqrt\(/g, '√(')
                .replace(/exp\(/g, 'e^(')
                .replace(/Math\.PI/g, 'π')
                .replace(/Math\.E/g, 'e');
        }

        function appendNumber(num) {
            if (appendToActiveInput(String(num))) {
                return;
            }

            // Ansonsten normale Taschenrechner-Funktion
            if (shouldResetInput || currentInput === '0') {
                currentInput = String(num);
                shouldResetInput = false;
            } else {
                currentInput += num;
            }
            updateDisplay();
        }

        function appendOperator(op) {
            if (appendToActiveInput(op)) {
                return;
            }

            // Ansonsten normale Taschenrechner-Funktion
            shouldResetInput = false;
            if (currentInput.slice(-1).match(/[\+\-\*\/\=]/)) {
                currentInput = currentInput.slice(0, -1) + op;
            } else {
                currentInput += op;
            }
            updateDisplay();
        }

        function appendFunction(func) {
            if (appendToActiveInput(func)) {
                return;
            }

            if (shouldResetInput || currentInput === '0') {
                currentInput = func;
                shouldResetInput = false;
            } else {
                currentInput += func;
            }
            updateDisplay();
        }

        function clearAll() {
            currentInput = '0';
            result = 0;
            shouldResetInput = false;
            updateDisplay();
        }

        function clearEntry() {
            currentInput = '0';
            updateDisplay();
        }

        function backspace() {
            if (activeInputField) {
                const currentValue = activeInputField.value || '';
                activeInputField.value = currentValue.slice(0, -1);
                return;
            }

            // Ansonsten normale Taschenrechner-Funktion
            if (currentInput.length > 1) {
                currentInput = currentInput.slice(0, -1);
            } else {
                currentInput = '0';
            }
            updateDisplay();
        }

        function calculate() {
            try {
                let expression = addImplicitMultiplication(
                    normalizeUnaryMinusExponent(
                        normalizeConstants(convertRootInfix(convertLogBaseSyntax(currentInput)))
                    )
                )
                    .replace(/×/g, '*')
                    .replace(/÷/g, '/')
                    .replace(/−/g, '-')
                    .replace(/\^/g, '**')
                    .replace(/sqrt\(/g, 'Math.sqrt(')
                    .replace(/exp\(/g, 'Math.exp(')
                    .replace(/ln\(/g, 'Math.log(')
                    .replace(/sin\(/g, 'Math.sin(')
                    .replace(/cos\(/g, 'Math.cos(')
                    .replace(/tan\(/g, 'Math.tan(');

                result = eval(expression);
                result = Math.round(result * 1000000000) / 1000000000;

                shouldResetInput = true;
                updateDisplay();
            } catch (error) {
                result = 'Fehler';
                updateDisplay();
            }
        }

        function handleExecute() {
            if (!executeActivePanel()) {
                calculate();
            }
        }

        function executeActivePanel() {
            if (activePanel === 'lgs') {
                solveLGS();
                return true;
            }
            if (activePanel === 'binom') {
                calculateBinomial();
                return true;
            }
            if (activePanel === 'equation') {
                solveEquation();
                return true;
            }
            return false;
        }

        function addImplicitMultiplication(value) {
            return value
                .replace(/(\d)([a-zA-Z(])/g, '$1*$2')
                .replace(/(\))([\d(])/g, '$1*$2')
                .replace(/(\))([a-zA-Z])/g, '$1*$2');
        }

        function normalizeUnaryMinusExponent(value) {
            return value
                .replace(/(^|[+\-*/(=])\s*-\s*([a-zA-Z0-9.]+)\s*\^/g, '$1(-1)*$2^')
                .replace(/(^|[+\-*/(=])\s*-\s*(\([^()]*\))\s*\^/g, '$1(-1)*$2^');
        }

        function normalizeConstants(value) {
            return value
                .replace(/(^|[^a-zA-Z0-9_.])e([^a-zA-Z0-9_]|$)/g, '$1Math.E$2')
                .replace(/(^|[^a-zA-Z0-9_.])pi([^a-zA-Z0-9_]|$)/gi, '$1Math.PI$2')
                .replace(/π/g, 'Math.PI');
        }

        function convertRootInfix(value) {
            let expr = value;
            let index = expr.indexOf('√');

            while (index !== -1) {
                const left = findLeftOperand(expr, index - 1);
                const right = findRightOperand(expr, index + 1);

                if (!left || !right) {
                    break;
                }

                const leftValue = expr.slice(left.start, left.end + 1);
                const rightValue = expr.slice(right.start, right.end + 1);

                expr = `${expr.slice(0, left.start)}root(${leftValue},${rightValue})${expr.slice(right.end + 1)}`;
                index = expr.indexOf('√');
            }

            return expr;
        }

        function convertLogBaseSyntax(value) {
            let expr = value;
            let index = expr.indexOf('log_(');

            while (index !== -1) {
                const baseStart = index + 4;
                const base = extractParenthesized(expr, baseStart);
                if (!base) {
                    break;
                }

                const afterBase = base.end + 1;
                const valueStart = findNextNonSpace(expr, afterBase);
                if (valueStart === null || expr[valueStart] !== '(') {
                    break;
                }

                const valuePart = extractParenthesized(expr, valueStart);
                if (!valuePart) {
                    break;
                }

                const baseValue = expr.slice(base.start + 1, base.end);
                const valueValue = expr.slice(valuePart.start + 1, valuePart.end);
                expr = `${expr.slice(0, index)}logBase(${baseValue},${valueValue})${expr.slice(valuePart.end + 1)}`;
                index = expr.indexOf('log_(');
            }

            return expr;
        }

        function extractParenthesized(expr, startIndex) {
            if (expr[startIndex] !== '(') {
                return null;
            }

            let depth = 1;
            let i = startIndex + 1;
            while (i < expr.length) {
                if (expr[i] === '(') depth++;
                if (expr[i] === ')') depth--;
                if (depth === 0) break;
                i++;
            }
            if (i >= expr.length) {
                return null;
            }
            return { start: startIndex, end: i };
        }

        function findNextNonSpace(expr, startIndex) {
            let i = startIndex;
            while (i < expr.length && expr[i] === ' ') {
                i++;
            }
            return i < expr.length ? i : null;
        }

        function logBase(base, value) {
            return Math.log(value) / Math.log(base);
        }

        function findLeftOperand(expr, endIndex) {
            let end = endIndex;
            while (end >= 0 && expr[end] === ' ') {
                end--;
            }
            if (end < 0) return null;

            if (expr[end] === ')') {
                let depth = 1;
                let i = end - 1;
                while (i >= 0) {
                    if (expr[i] === ')') depth++;
                    if (expr[i] === '(') depth--;
                    if (depth === 0) break;
                    i--;
                }
                if (i < 0) return null;
                return { start: i, end };
            }

            let i = end;
            while (i >= 0 && /[a-zA-Z0-9.]/.test(expr[i])) {
                i--;
            }
            let start = i + 1;
            if (start > 0 && expr[start - 1] === '-' && (start - 1 === 0 || /[+\-*/(=]/.test(expr[start - 2]))) {
                start--;
            }
            return start <= end ? { start, end } : null;
        }

        function findRightOperand(expr, startIndex) {
            let start = startIndex;
            while (start < expr.length && expr[start] === ' ') {
                start++;
            }
            if (start >= expr.length) return null;

            if (expr[start] === '(') {
                let depth = 1;
                let i = start + 1;
                while (i < expr.length) {
                    if (expr[i] === '(') depth++;
                    if (expr[i] === ')') depth--;
                    if (depth === 0) break;
                    i++;
                }
                if (i >= expr.length) return null;
                return { start, end: i };
            }

            let i = start;
            if (expr[i] === '-' && i + 1 < expr.length && /[a-zA-Z0-9(]/.test(expr[i + 1])) {
                i++;
            }
            while (i < expr.length && /[a-zA-Z0-9.]/.test(expr[i])) {
                i++;
            }
            const end = i - 1;
            return end >= start ? { start, end } : null;
        }

        function root(x, y) {
            return Math.pow(y, 1 / x);
        }

        function toggleSign() {
            if (activeInputField) {
                const value = activeInputField.value || '';
                if (value.startsWith('-')) {
                    activeInputField.value = value.slice(1);
                } else if (value.length > 0) {
                    activeInputField.value = '-' + value;
                }
                return;
            }

            const numericPattern = /^-?\d+(\.\d+)?$/;
            if (numericPattern.test(currentInput)) {
                currentInput = currentInput.startsWith('-') ? currentInput.slice(1) : '-' + currentInput;
                updateDisplay();
            }
        }

        function appendToActiveInput(value) {
            if (!activeInputField || !panelInputMode) {
                return false;
            }

            const currentValue = activeInputField.value || '';
            if (activeInputField.type === 'number' || activeInputField.type === 'text') {
                const hasSeparator = currentValue.includes('.') || currentValue.includes(',');
                if ((value === '.' || value === ',') && hasSeparator) {
                    return true;
                }
                if ((value === '.' || value === ',') && (currentValue === '' || currentValue === '-')) {
                    activeInputField.value = `${currentValue}0${value}`;
                    return true;
                }
            }

            activeInputField.value = currentValue + value;
            return true;
        }

        function normalizeNumberString(value) {
            return value.replace(/,/g, '.');
        }

        function factorial() {
            try {
                let n = parseInt(result || currentInput);
                if (n < 0) {
                    result = 'Fehler';
                } else if (n === 0 || n === 1) {
                    result = 1;
                } else {
                    let fact = 1;
                    for (let i = 2; i <= n; i++) {
                        fact *= i;
                    }
                    result = fact;
                }
                currentInput = String(result);
                shouldResetInput = true;
                updateDisplay();
            } catch (error) {
                result = 'Fehler';
                updateDisplay();
            }
        }

        // Panel Toggle
        function togglePanel(panelName) {
            const panels = ['lgs', 'binom', 'equation'];
            const buttons = ['lgsBtn', 'binomBtn', 'equationBtn'];

            panels.forEach((p, idx) => {
                const panel = document.getElementById(p + 'Panel');
                const btn = document.getElementById(buttons[idx]);

                if (p === panelName) {
                    if (activePanel === panelName) {
                        panel.classList.remove('open');
                        btn.classList.remove('active');
                        activePanel = null;
                        activeInputField = null;
                        panelInputMode = false;
                    } else {
                        panel.classList.add('open');
                        btn.classList.add('active');
                        activePanel = panelName;
                    }
                } else {
                    panel.classList.remove('open');
                    btn.classList.remove('active');
                }
            });

            if (!activePanel) {
                activeInputField = null;
                panelInputMode = false;
            }
        }

        // LGS Funktionen
        function initLGS() {
            lgsVariables = 2;
            lgsEquations = 2;
            renderLGS();
        }

        function renderLGS() {
            const container = document.getElementById('lgsMatrix');
            container.innerHTML = '';

            const varNames = ['x', 'y', 'z', 'u', 'v', 'w'];

            for (let i = 0; i < lgsEquations; i++) {
                const row = document.createElement('div');
                row.className = 'input-row';

                for (let j = 0; j < lgsVariables; j++) {
                    // + oder - Zeichen vor Variable (außer beim ersten)
                    if (j > 0) {
                        const plusMinus = document.createElement('span');
                        plusMinus.textContent = '+';
                        plusMinus.style.padding = '0 2px';
                        plusMinus.style.fontSize = '11px';
                        row.appendChild(plusMinus);
                    }

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.inputMode = shouldLockTouchInputs ? 'none' : 'decimal';
                    input.readOnly = shouldLockTouchInputs;
                    input.id = `a${i}${j}`;
                    input.placeholder = '';
                    input.value = '';
                    row.appendChild(input);

                    // Variablenname nach dem Input
                    const varLabel = document.createElement('span');
                    varLabel.textContent = varNames[j] || `x${j + 1}`;
                    varLabel.style.padding = '0 2px';
                    varLabel.style.fontSize = '11px';
                    varLabel.style.fontWeight = 'bold';
                    row.appendChild(varLabel);
                }

                const equals = document.createElement('span');
                equals.textContent = '=';
                equals.style.padding = '0 4px';
                equals.style.fontWeight = 'bold';
                equals.style.fontSize = '11px';
                row.appendChild(equals);

                const resultInput = document.createElement('input');
                resultInput.type = 'text';
                resultInput.inputMode = shouldLockTouchInputs ? 'none' : 'decimal';
                resultInput.readOnly = shouldLockTouchInputs;
                resultInput.id = `b${i}`;
                resultInput.placeholder = '';
                resultInput.value = '';
                row.appendChild(resultInput);

                container.appendChild(row);
            }

            applyTouchInputLock();
        }

        function addLGSVariable() {
            if (lgsVariables < 5) {
                lgsVariables++;
                renderLGS();
            }
        }

        function removeLGSVariable() {
            if (lgsVariables > 1) {
                lgsVariables--;
                renderLGS();
            }
        }

        function addLGSEquation() {
            if (lgsEquations < 5) {
                lgsEquations++;
                renderLGS();
            }
        }

        function removeLGSEquation() {
            if (lgsEquations > 1) {
                lgsEquations--;
                renderLGS();
            }
        }

        function solveLGS() {
            try {
                // Prüfe ob System lösbar ist
                if (lgsEquations !== lgsVariables) {
                    currentInput = 'LGS: Anzahl Gleichungen ≠ Variablen';
                    result = 'Nicht eindeutig';
                    updateDisplay();
                    return;
                }

                // Matrix A und Vektor b erstellen
                const A = [];
                const b = [];

                for (let i = 0; i < lgsEquations; i++) {
                    A[i] = [];
                    for (let j = 0; j < lgsVariables; j++) {
                        const cellValue = document.getElementById(`a${i}${j}`).value;
                        A[i][j] = parseFloat(normalizeNumberString(cellValue)) || 0;
                    }
                    const resultValue = document.getElementById(`b${i}`).value;
                    b[i] = parseFloat(normalizeNumberString(resultValue)) || 0;
                }

                // Gauß-Elimination mit Sonderfaellen
                const solution = solveLinearSystem(A, b);

                if (solution.status === 'inconsistent') {
                    currentInput = 'LGS: Keine Lösung';
                    result = 'Keine Lösung';
                } else if (solution.status === 'infinite') {
                    currentInput = 'LGS: Unendlich viele Lösungen';
                    result = solution.parametric.join(', ');
                } else {
                    currentInput = 'LGS gelöst';
                    result = solution.values.map((x, i) => `x${i + 1}=${formatNumber(x)}`).join(', ');
                }

                shouldResetInput = true;
                updateDisplay();
            } catch (error) {
                currentInput = 'LGS Fehler';
                result = 'Fehler';
                updateDisplay();
            }
        }

        function solveLinearSystem(A, b) {
            const rows = A.length;
            const cols = A[0]?.length || 0;
            const augmented = A.map((row, i) => [...row, b[i]]);
            const pivotCols = [];
            let r = 0;
            const eps = 1e-10;

            for (let c = 0; c < cols && r < rows; c++) {
                let pivotRow = r;
                for (let i = r + 1; i < rows; i++) {
                    if (Math.abs(augmented[i][c]) > Math.abs(augmented[pivotRow][c])) {
                        pivotRow = i;
                    }
                }

                if (Math.abs(augmented[pivotRow][c]) < eps) {
                    continue;
                }

                if (pivotRow !== r) {
                    [augmented[r], augmented[pivotRow]] = [augmented[pivotRow], augmented[r]];
                }

                const pivotVal = augmented[r][c];
                for (let j = c; j <= cols; j++) {
                    augmented[r][j] /= pivotVal;
                }

                for (let i = 0; i < rows; i++) {
                    if (i === r) continue;
                    const factor = augmented[i][c];
                    if (Math.abs(factor) < eps) continue;
                    for (let j = c; j <= cols; j++) {
                        augmented[i][j] -= factor * augmented[r][j];
                    }
                }

                pivotCols.push(c);
                r++;
            }

            // Inkonsistenz pruefen
            for (let i = 0; i < rows; i++) {
                let allZero = true;
                for (let j = 0; j < cols; j++) {
                    if (Math.abs(augmented[i][j]) >= eps) {
                        allZero = false;
                        break;
                    }
                }
                if (allZero && Math.abs(augmented[i][cols]) >= eps) {
                    return { status: 'inconsistent' };
                }
            }

            if (pivotCols.length === cols) {
                const values = new Array(cols).fill(0);
                for (let i = 0; i < pivotCols.length; i++) {
                    const col = pivotCols[i];
                    values[col] = augmented[i][cols];
                }
                return { status: 'unique', values };
            }

            const freeCols = [];
            for (let j = 0; j < cols; j++) {
                if (!pivotCols.includes(j)) {
                    freeCols.push(j);
                }
            }

            const paramNames = ['t', 's', 'r', 'u', 'v', 'w'];
            const paramMap = new Map();
            freeCols.forEach((col, idx) => {
                paramMap.set(col, paramNames[idx] || `p${idx + 1}`);
            });

            const expressions = new Array(cols).fill('0');

            freeCols.forEach((col) => {
                expressions[col] = paramMap.get(col);
            });

            for (let i = 0; i < pivotCols.length; i++) {
                const col = pivotCols[i];
                let expr = formatNumber(augmented[i][cols]);
                freeCols.forEach((freeCol) => {
                    const coeff = -augmented[i][freeCol];
                    if (Math.abs(coeff) < eps) return;
                    const sign = coeff >= 0 ? ' + ' : ' - ';
                    const absCoeff = Math.abs(coeff);
                    const coeffText = absCoeff === 1 ? '' : formatNumber(absCoeff);
                    expr += `${sign}${coeffText}${paramMap.get(freeCol)}`;
                });
                expressions[col] = expr;
            }

            const parametric = expressions.map((expr, idx) => `x${idx + 1}=${expr}`);
            return { status: 'infinite', parametric };
        }

        function formatNumber(value) {
            const rounded = Math.round(value * 1000000) / 1000000;
            const text = rounded.toFixed(6);
            return text.replace(/\.0+$/, '').replace(/(\.\d*?)0+$/, '$1');
        }

        // Binomialwahrscheinlichkeit
        function binomialCoefficient(n, k) {
            if (k < 0 || k > n) return 0;
            if (k === 0 || k === n) return 1;

            let result = 1;
            for (let i = 1; i <= k; i++) {
                result *= (n - k + i) / i;
            }
            return Math.round(result);
        }

        function calculateBinomial() {
            const nInput = document.getElementById('binomN').value;
            const pInput = document.getElementById('binomP').value;
            const aInput = document.getElementById('binomA').value;
            const bInput = document.getElementById('binomB').value;

            const n = parseInt(normalizeNumberString(nInput));
            const p = parseFloat(normalizeNumberString(pInput));
            const aRaw = parseFloat(normalizeNumberString(aInput));
            const bRaw = parseFloat(normalizeNumberString(bInput));
            const a = Math.ceil(aRaw);
            const b = Math.floor(bRaw);

            let probability = 0;
            for (let k = a; k <= b; k++) {
                const binomCoeff = binomialCoefficient(n, k);
                probability += binomCoeff * Math.pow(p, k) * Math.pow(1 - p, n - k);
            }

            const pDisplay = pInput !== '' ? pInput : String(p);
            currentInput = `Binom(a=${a}, b=${b}, n=${n}, p=${pDisplay})`;
            result = Math.round(probability * 1000000) / 1000000;
            shouldResetInput = true;
            updateDisplay();
        }

        // Gleichungslöser
        function solveEquation() {
            const equation = document.getElementById('equationInput').value;

            try {
                let [leftSide, rightSide] = equation.split('=').map(s => s.trim());
                if (!rightSide) rightSide = '0';

                function f(x) {
                    let expr = `(${leftSide}) - (${rightSide})`;
                    expr = addImplicitMultiplication(
                        normalizeUnaryMinusExponent(
                            normalizeConstants(convertRootInfix(convertLogBaseSyntax(expr)))
                        )
                    )
                        .replace(/x/g, `(${x})`)
                        .replace(/\^/g, '**')
                        .replace(/e\*\*/g, 'Math.E**')
                        .replace(/sqrt/g, 'Math.sqrt')
                        .replace(/root/g, 'root')
                        .replace(/exp/g, 'Math.exp')
                        .replace(/ln/g, 'Math.log')
                        .replace(/log/g, 'Math.log10')
                        .replace(/sin/g, 'Math.sin')
                        .replace(/cos/g, 'Math.cos')
                        .replace(/tan/g, 'Math.tan');
                    return eval(expr);
                }

                function refineRoot(a, b, tolerance) {
                    let fa = f(a);
                    let fb = f(b);
                    if (isNaN(fa) || isNaN(fb)) {
                        return null;
                    }
                    if (Math.abs(fa) < tolerance) return a;
                    if (Math.abs(fb) < tolerance) return b;
                    if (fa * fb > 0) return null;

                    let left = a;
                    let right = b;
                    for (let i = 0; i < 100; i++) {
                        const mid = (left + right) / 2;
                        const fm = f(mid);
                        if (isNaN(fm)) {
                            return null;
                        }
                        if (Math.abs(fm) < tolerance) {
                            return mid;
                        }
                        if (fa * fm <= 0) {
                            right = mid;
                            fb = fm;
                        } else {
                            left = mid;
                            fa = fm;
                        }
                    }
                    return (left + right) / 2;
                }

                const tolerance = 0.000001;
                const rangeMin = -100;
                const rangeMax = 100;
                const steps = 2000;
                const step = (rangeMax - rangeMin) / steps;
                const roots = [];

                for (let i = 0; i < steps; i++) {
                    const x1 = rangeMin + i * step;
                    const x2 = x1 + step;
                    const f1 = f(x1);
                    const f2 = f(x2);

                    if (isNaN(f1) || isNaN(f2)) {
                        continue;
                    }

                    if (Math.abs(f1) < tolerance) {
                        roots.push(x1);
                        continue;
                    }

                    if (f1 * f2 < 0) {
                        const root = refineRoot(x1, x2, tolerance);
                        if (root !== null) {
                            roots.push(root);
                        }
                    }
                }

                const uniqueRoots = roots
                    .map(r => Math.round(r * 1000000) / 1000000)
                    .sort((a, b) => a - b)
                    .filter((r, idx, arr) => idx === 0 || Math.abs(r - arr[idx - 1]) > 0.00001);

                if (uniqueRoots.length === 0) {
                    result = 'Keine Lösung';
                    currentInput = equation;
                } else {
                    result = uniqueRoots.join(', ');
                    currentInput = `${equation} → x =`;
                    shouldResetInput = true;
                }

                updateDisplay();
            } catch (error) {
                result = 'Fehler beim Lösen';
                currentInput = equation;
                updateDisplay();
            }
        }

        // Tastatur-Support
        document.addEventListener('keydown', function (event) {
            const isPanelInputFocused = activeInputField && document.activeElement === activeInputField;
            if (isPanelInputFocused && event.key !== 'Enter') {
                return;
            }

            if (event.key === 'Dead' && (event.code === 'Backquote' || event.code === 'BracketLeft')) {
                appendOperator('^');
                event.preventDefault();
            } else if (event.key >= '0' && event.key <= '9') {
                appendNumber(event.key);
            } else if (event.key === '.' || event.key === ',') {
                appendNumber(event.key);
            } else if (event.key === '+' || event.key === '-' || event.key === '*' || event.key === '/') {
                appendOperator(event.key);
            } else if (event.key === '^') {
                appendOperator('^');
                event.preventDefault();
            } else if (event.key === '(' || event.key === ')') {
                appendNumber(event.key);
            } else if (event.key === '=') {
                appendOperator('=');
            } else if (event.key === 'Enter') {
                event.preventDefault();
                handleExecute();
            } else if (event.key === 'Escape') {
                clearAll();
            } else if (event.key === 'Backspace') {
                backspace();
            }
        });

        // Initialisierung
        initLGS();
        updateDisplay();
        applyTouchInputLock();

        function isDragAllowed(target) {
            if (!target) return false;
            return !target.closest('button, input, select, textarea, a');
        }

        (function setupCalculatorDrag() {
            const calculator = document.querySelector('.calculator');
            if (!calculator || !window.parent) return;

            let dragging = false;

            calculator.addEventListener('pointerdown', (event) => {
                if (!isDragAllowed(event.target)) {
                    return;
                }
                dragging = true;
                window.parent.postMessage(
                    {
                        type: 'calculatorDragStart',
                        clientX: event.clientX,
                        clientY: event.clientY
                    },
                    window.location.origin
                );
            });

            calculator.addEventListener('pointermove', (event) => {
                if (!dragging) return;
                window.parent.postMessage(
                    {
                        type: 'calculatorDragMove',
                        clientX: event.clientX,
                        clientY: event.clientY
                    },
                    window.location.origin
                );
            });

            calculator.addEventListener('pointerup', () => {
                if (!dragging) return;
                dragging = false;
                window.parent.postMessage({ type: 'calculatorDragEnd' }, window.location.origin);
            });

            calculator.addEventListener('pointercancel', () => {
                if (!dragging) return;
                dragging = false;
                window.parent.postMessage({ type: 'calculatorDragEnd' }, window.location.origin);
            });
        })();

        // Event-Listener für alle Input-Felder in den Panels
        document.addEventListener('focusin', function (event) {
            if (event.target.tagName === 'INPUT' && event.target.type !== 'button') {
                activeInputField = event.target;
                panelInputMode = true;
            }
        });

        // Nur Fokus verlieren wenn außerhalb der Panels geklickt wird
        document.addEventListener('click', function (event) {
            const isDisplay = event.target.closest('.display');
            const isPanelArea = event.target.closest('.special-functions');
            const isKeypad = event.target.closest('.buttons');

            if (isDisplay || (!isPanelArea && !isKeypad)) {
                activeInputField = null;
                panelInputMode = false;
            }
        });
    </script>
</body>

</html>